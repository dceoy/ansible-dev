---
- name: Set variables
  set_fact:
    r_libs: "{{ ansible_env.HOME }}/.clir/r/library"
    clir_root: "{{ ansible_env.HOME }}/.clir"
    clir: "{{ ansible_env.HOME }}/.clir/bin/clir"

- name: Check R command
  shell: |
    R --version

- name: Check .clir
  stat:
    path: "{{ clir_root }}"
  register: clir_st

- name: Clone clir
  git:
    repo: 'https://github.com/dceoy/clir.git'
    dest: "{{ ansible_env.HOME }}/.clir"
  notify: Notify updates of R via Slack

- name: Set cran repositories
  environment:
    R_LIBS: "{{ r_libs }}"
  shell: |
    {{ clir }} set-cran {{ item }}
  with_items: "{{ r_repos.cran }}"
  notify: Notify updates of R via Slack

- name: Set drat repositories
  when: r_repos.drat is defined
  environment:
    R_LIBS: "{{ r_libs }}"
  shell: |
    {{ clir }} set-drat {{ item }}
  with_items: "{{ r_repos.drat }}"
  notify: Notify updates of R via Slack

- name: Install and update cran packages
  environment:
    R_LIBS: "{{ r_libs }}"
  shell: |
    {{ clir }} cran-install --quiet {{ item }}
  with_items:
    - devtools
    - drat
    - "{{ r_packages.cran }}"
  ignore_errors: true
  notify: Notify updates of R via Slack

- name: Install and update drat packages
  when:
    - r_repos.drat is defined
    - r_packages.drat is defined
  environment:
    R_LIBS: "{{ r_libs }}"
  shell: |
    {{ clir }} cran-install --quiet {{ item }}
  with_items: "{{ r_packages.drat }}"
  ignore_errors: true
  notify: Notify updates of R via Slack

- name: Install and update github packages
  when: r_packages.github is defined
  environment:
    R_LIBS: "{{ r_libs }}"
  shell: |
    {{ clir }} github-install --quiet {{ item }}
  with_items: "{{ r_packages.github }}"
  ignore_errors: true
  notify: Notify updates of R via Slack

- name: Install and update bioconductor packages
  when: r_packages.bioconductor is defined
  environment:
    R_LIBS: "{{ r_libs }}"
  shell: |
    {{ clir }} bioc-install --quiet {{ item }}
  with_items: "{{ r_packages.bioconductor }}"
  ignore_errors: true
  notify: Notify updates of R via Slack
